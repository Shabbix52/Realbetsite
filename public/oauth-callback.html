<!DOCTYPE html>
<html>
<head><title>Authenticating...</title></head>
<body style="background:#0D0D0D;color:#fff;font-family:sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0">
  <div style="text-align:center">
    <p id="msg">Connecting...</p>
    <p style="opacity:0.5;font-size:14px">This window will close automatically...</p>
  </div>
  <script>
    console.log('[OAuthCallback] Page loaded, URL:', window.location.href);
    try {
      var params = new URLSearchParams(window.location.search);
      var raw = params.get('data');
      console.log('[OAuthCallback] Raw data param present:', !!raw);
      if (raw) {
        var data = JSON.parse(decodeURIComponent(raw));
        console.log('[OAuthCallback] Parsed:', JSON.stringify({success: data.success, provider: data.provider, username: data.user ? data.user.username : null}));
        document.getElementById('msg').textContent = data.success ? 'Connected!' : 'Connection failed';

        // Write to localStorage — primary channel
        try {
          localStorage.setItem('oauth_result', JSON.stringify(data));
          console.log('[OAuthCallback] localStorage written OK');
          var verify = localStorage.getItem('oauth_result');
          console.log('[OAuthCallback] localStorage verify:', !!verify);
        } catch(e) {
          console.error('[OAuthCallback] localStorage FAILED:', e);
        }

        // postMessage to opener — backup channel
        console.log('[OAuthCallback] window.opener:', !!window.opener);
        if (window.opener) {
          try {
            window.opener.postMessage(data, '*');
            console.log('[OAuthCallback] postMessage sent');
          } catch(e) {
            console.error('[OAuthCallback] postMessage FAILED:', e);
          }
        }
      } else {
        console.warn('[OAuthCallback] No data param in URL');
        document.getElementById('msg').textContent = 'No data received';
      }
    } catch(e) {
      console.error('[OAuthCallback] Exception:', e);
      document.getElementById('msg').textContent = 'Error: ' + e.message;
    }
    setTimeout(function() { window.close(); }, 2500);
  </script>
</body>
</html>
